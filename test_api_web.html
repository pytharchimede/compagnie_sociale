<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API Compagnie Sociale</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .test-section { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .info { color: blue; }
        pre { background: #333; color: white; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { background: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 3px; cursor: pointer; margin: 5px; }
        button:hover { background: #1976D2; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>üß™ Test API Compagnie Sociale CI</h1>
    
    <div class="test-section">
        <h2>Configuration</h2>
        <p><strong>API Base URL:</strong> <span id="apiUrl">https://fidest.ci/rencontre/backend-api/api</span></p>
        <p><strong>Email de test:</strong> <input type="email" id="testEmail" value="test_web@example.com" style="width: 250px;"></p>
        <p><strong>Mot de passe:</strong> <input type="password" id="testPassword" value="test123456" style="width: 150px;"></p>
    </div>

    <div class="test-section">
        <h2>Tests Automatiques</h2>
        <button onclick="runAllTests()">üöÄ Lancer tous les tests</button>
        <button onclick="clearResults()">üßπ Effacer les r√©sultats</button>
    </div>

    <div class="test-section">
        <h2>Tests Manuels</h2>
        <button onclick="testConnectivity()">1. Test de connectivit√©</button>
        <button onclick="testRegister()">2. Test d'inscription</button>
        <button onclick="testLogin()">3. Test de connexion</button>
        <button onclick="testSync()">4. Test de synchronisation</button>
    </div>

    <div id="results"></div>

    <script>
        const API_BASE = 'https://fidest.ci/rencontre/backend-api/api';
        let currentUserId = null;

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            results.innerHTML += `<div class="${className}">${message}</div>`;
            console.log(message);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function makeRequest(endpoint, data = null, method = 'GET') {
            const url = `${API_BASE}/${endpoint}`;
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            };

            if (data && method === 'POST') {
                options.body = JSON.stringify(data);
            }

            try {
                log(`üì° ${method} ${url}`);
                if (data) {
                    log(`üì§ Donn√©es envoy√©es: <pre>${JSON.stringify(data, null, 2)}</pre>`);
                }

                const response = await fetch(url, options);
                const responseText = await response.text();
                
                log(`üì• Status: ${response.status}`);
                log(`üì• R√©ponse: <pre>${responseText}</pre>`);

                let responseData;
                try {
                    responseData = JSON.parse(responseText);
                } catch (e) {
                    log(`‚ö†Ô∏è R√©ponse non-JSON: ${responseText}`, 'error');
                    return { success: false, error: 'R√©ponse non-JSON' };
                }

                if (response.status === 200) {
                    log(`‚úÖ Succ√®s!`, 'success');
                    return responseData;
                } else {
                    log(`‚ùå Erreur HTTP ${response.status}`, 'error');
                    return responseData;
                }
            } catch (error) {
                log(`‚ùå Erreur r√©seau: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        async function testConnectivity() {
            log('<h3>üîå Test de connectivit√©</h3>');
            const result = await makeRequest('debug.php');
            if (result.success) {
                log('‚úÖ API accessible et fonctionnelle', 'success');
            } else {
                log('‚ùå API non accessible', 'error');
            }
            log('<hr>');
        }

        async function testRegister() {
            log('<h3>üìù Test d\'inscription</h3>');
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            
            const data = {
                email: email,
                password: password,
                firstName: 'TestWeb',
                lastName: 'User',
                phone: '0123456789'
            };

            const result = await makeRequest('register.php', data, 'POST');
            if (result.success) {
                log('‚úÖ Inscription r√©ussie', 'success');
                if (result.user && result.user.id) {
                    currentUserId = result.user.id;
                    log(`üÜî ID utilisateur: ${currentUserId}`, 'info');
                }
            } else {
                log(`‚ùå Inscription √©chou√©e: ${result.message}`, 'error');
            }
            log('<hr>');
        }

        async function testLogin() {
            log('<h3>üîê Test de connexion</h3>');
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;

            const data = {
                email: email,
                password: password
            };

            const result = await makeRequest('login.php', data, 'POST');
            if (result.success) {
                log('‚úÖ Connexion r√©ussie', 'success');
                if (result.user && result.user.id) {
                    currentUserId = result.user.id;
                    log(`üÜî ID utilisateur connect√©: ${currentUserId}`, 'info');
                }
            } else {
                log(`‚ùå Connexion √©chou√©e: ${result.message}`, 'error');
            }
            log('<hr>');
        }

        async function testSync() {
            log('<h3>üîÑ Test de synchronisation</h3>');
            
            if (!currentUserId) {
                log('‚ùå Pas d\'ID utilisateur. Faites d\'abord l\'inscription ou la connexion.', 'error');
                return;
            }

            const email = document.getElementById('testEmail').value;
            const data = {
                user: {
                    id: currentUserId,
                    email: email,
                    firstName: 'TestSync',
                    lastName: 'UserSync',
                    phone: '0987654321',
                    isPremium: true,
                    preferences: ['theme: dark']
                }
            };

            const result = await makeRequest('sync_user.php', data, 'POST');
            if (result.success) {
                log('‚úÖ Synchronisation r√©ussie', 'success');
            } else {
                log(`‚ùå Synchronisation √©chou√©e: ${result.message}`, 'error');
            }
            log('<hr>');
        }

        async function runAllTests() {
            clearResults();
            log('<h2>üöÄ Lancement de tous les tests</h2>');
            
            // G√©n√©rer un email unique pour √©viter les conflits
            const timestamp = new Date().getTime();
            document.getElementById('testEmail').value = `test_${timestamp}@example.com`;
            
            await testConnectivity();
            await new Promise(resolve => setTimeout(resolve, 1000)); // Pause 1s
            
            await testRegister();
            await new Promise(resolve => setTimeout(resolve, 1000)); // Pause 1s
            
            await testLogin();
            await new Promise(resolve => setTimeout(resolve, 1000)); // Pause 1s
            
            await testSync();
            
            log('<h2>üèÅ Tests termin√©s</h2>');
        }

        // Auto-g√©n√©rer un email unique au chargement
        window.onload = function() {
            const timestamp = new Date().getTime();
            document.getElementById('testEmail').value = `test_${timestamp}@example.com`;
        };
    </script>
</body>
</html>
